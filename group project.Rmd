---
title: "Question 2"
author: "Eva Burguete-Innocente"
date: "`r Sys.Date()`"
output: html_document
---

Question 1a: How does heritability change as you move up the taxonomic rank?
1b: How does domestication affect heritability
Hypothesis 1a: Heritability will increase/decrease as you move up the taxonomic rank.
1b: Heritability will be higher for domesticated individuals.

A high heritability indicates that much of the phenotypic variation is attributable to genetic differences amongst individuals. 

-in the paper- species was a random effect and they did not find significnat effects of taxonomy 

Loading necessary packages:

```{r}
library(ggplot2)
library(dplyr)
library(stringr)
library(lmtest)
library(lme4)
```

Reading in the data and checking it:

```{r}
data<-read.csv("heritability.csv")
head(data)
str(data)
```

Using regular expressions to filter out mistakes in the data:

```{r}
data%>%
  filter(str_detect(Genus,"^T"))

#remove Tachymarptis\xa0 and replace with Tachymarptis

data$Genus<-gsub("Tachymarptis\xa0","Tachymarptis",data$Genus)

```


First: linear model to see effects of domesticated and wild on heritability and plot domesticated/wild vs heritability

```{r}
summary(lm(Zr~D.W,data=data))
ggplot(data,aes(D.W,Zr))+geom_boxplot() 
```

Wild, semi domesticated, and domesticated have a significant effect on heritability.


include significant models



Plotting the effects of other variables on heritability.

```{r}
ggplot(data,aes(L.F,Zr))+geom_boxplot()

ggplot(data,aes(Thermy,Zr))+geom_boxplot()

ggplot(data,aes(Vert,Zr))+geom_boxplot()

ggplot(data,aes(D.W,Zr))+geom_boxplot() 
```
seeing how D.W. affects Zr across taxa

```{r}
ggplot(data,aes(D.W,Zr,fill=Phylum))+geom_boxplot() 

ggplot(data,aes(D.W,Zr,fill=Class))+geom_boxplot() 

ggplot(data,aes(D.W,Zr,fill=Order))+geom_boxplot()+theme(legend.position="none") 

ggplot(data,aes(D.W,Zr,fill=Family))+geom_boxplot()+theme(legend.position="none") 

ggplot(data,aes(D.W,Zr,fill=Genus))+geom_boxplot()+theme(legend.position="none") 

ggplot(data,aes(D.W,Zr,colour=Genus))+geom_point()+geom_jitter()+theme(legend.position="none") 
```

seeing how Zr differs across taxa

```{r}
ggplot(data,aes(Phylum,Zr,fill=Phylum))+geom_boxplot() 

ggplot(data,aes(Class,Zr,fill=Class))+geom_boxplot()

ggplot(data,aes(Order,Zr,fill=Order))+geom_boxplot()+theme(legend.position="none")

ggplot(data,aes(Family,Zr,fill=Family))+geom_boxplot()+theme(legend.position="none")

ggplot(data,aes(Genus,Zr,fill=Genus))+geom_boxplot()+theme(legend.position="none")

ggplot(data,aes(species.epithet,Zr,fill=species.epithet))+geom_boxplot()+theme(legend.position="none")
```

group by each rank and find the average Zr in each group of each rank

first- calculate average heritbaility for each rank.

```{r}
data%>%
  group_by(Phylum)%>%
  summarise(mean(Zr))

data%>%
  group_by(Class)%>%
  summarise(mean(Zr))

data%>%
  group_by(Order)%>%
  summarise(mean(Zr))

data%>%
  group_by(Family)%>%
  summarise(mean(Zr))

data%>%
  group_by(Genus)%>%
  summarise(mean(Zr))

data%>%
  group_by(species.epithet)%>%
  summarise(mean(Zr))
```

need to make a dataframe where: one column is Rank (Phylum, Class, Order, Family, Genus, (Species.epithet?)), next column is the names of each of the groups in each rank, third column is the avergae Zr.

attempting to plot average Zr across taxonomic levels 

-combine figure with domesticated and wild 

```{r}

#is this correct??
pivotdat<-data%>%
  select(Phylum,Class,Order,Family,Genus,species.epithet,Zr)%>%
  group_by(Phylum,Class,Order,Family,Genus,species.epithet)%>%
  mutate(meanZr=mean(Zr))

head(pivotdat)

library(tidyr)
  
longdat<-pivot_longer(pivotdat,cols=c("Phylum","Class","Order","Family","Genus","species.epithet"),names_to="Rank",values_to="Name")

#is this right?
longdatplot<-longdat%>%
  group_by(Rank,Name)%>%
  mutate(meanZr=mean(Zr))%>%
  select(Rank,Name,meanZr)
longdatplot

ggplot(longdatplot,aes(Rank,meanZr,fill=Rank))+geom_boxplot()+theme(legend.position="none")

#how to collapse this so theres only each observation once in the dataset?
#take average of all groups?

#why do they all end up the same
#filter based on phlyum
phylum<-longdatplot%>%
  filter(Rank=="Phylum")%>%
  summarise(mean(meanZr))
phylum

class<-longdatplot%>%
  filter(Rank=="Class")%>%
  summarise(mean(meanZr))

order<-longdatplot%>%
  filter(Rank=="Order")%>%
  summarise(mean(meanZr))

family<-longdatplot%>%
  filter(Rank=="Family")%>%
  summarise(mean(meanZr))

genus<-longdatplot%>%
  filter(Rank=="Genus")%>%
  summarise(mean(meanZr))

species<-longdatplot%>%
  filter(Rank=="species.epithet")%>%
  summarise(mean(meanZr))

#now make data frame from this which should have 244

plotdat2<-rbind(phylum,class,order,family,genus,species)
plotdat2<-plotdat2%>%
  mutate(avg=`mean(meanZr)`)%>%
  select(Rank,Name,avg)
plotdat2
rankplot<-ggplot(plotdat2,aes(Rank,avg))+geom_boxplot()+theme(legend.position="none")+theme_bw()+ylab("Average Heritability")+xlab("Taxonomic Rank")+scale_x_discrete(limits = c("Phylum", "Class","Order","Family","Genus","species.epithet"),labels= c("Phylum", "Class","Order","Family","Genus","Species"))
rankplot
#this didn't change anything
#yes it did- how and why
#I think this one is correct


#make graphs nice- rank and DW

png("rankplot.png")
print(rankplot)
dev.off()
```
ADDING DW

```{r}
pivotdat<-data%>%
  select(D.W,Phylum,Class,Order,Family,Genus,species.epithet,Zr)%>%
  group_by(Phylum,Class,Order,Family,Genus,species.epithet)%>%
  mutate(meanZr=mean(Zr))

head(pivotdat)

library(tidyr)
  
longdat<-pivot_longer(pivotdat,cols=c("Phylum","Class","Order","Family","Genus","species.epithet"),names_to="Rank",values_to="Name")
longdat
#is this right?
longdatplot<-longdat%>%
  group_by(Rank,Name)%>%
  mutate(meanZr=mean(Zr))%>%
  select(Rank,Name,meanZr,D.W)
longdatplot<-longdatplot%>%
  relocate(Rank,Name,D.W,meanZr)

ggplot(longdatplot,aes(Rank,meanZr,fill=D.W))+geom_boxplot()+theme(legend.position="none")
longdatplot

#how to include dw 
phylum<-longdatplot%>%
  filter(Rank=="Phylum")%>%
  mutate(avg=mean(meanZr))

phylum

class<-longdatplot%>%
  filter(Rank=="Class")%>%
  mutate(avg=mean(meanZr))
class

order<-longdatplot%>%
  filter(Rank=="Order")%>%
   mutate(avg=mean(meanZr))

family<-longdatplot%>%
  filter(Rank=="Family")%>%
   mutate(avg=mean(meanZr))

genus<-longdatplot%>%
  filter(Rank=="Genus")%>%
   mutate(avg=mean(meanZr))

species<-longdatplot%>%
  filter(Rank=="species.epithet")%>%
   mutate(avg=mean(meanZr))
species

#now make data frame from this which should have 244

plotdat2<-rbind(phylum,class,order,family,genus,species)
plotdat2
plotdat2<-plotdat2%>%
  select(Rank,Name,D.W,avg)%>%
  group_by(Rank,Name,D.W)%>%
  summarise(avg=mean(avg))

plotdat2

ggplot(plotdat2,aes(Rank,avg,fill=D.W))+geom_boxplot()+theme(legend.position="none")+theme_bw()+ylab("Average Heritability")+xlab("Taxonomic Rank")+labs(fill="Domestication")+scale_fill_discrete(labels=c("Domesticated","Semi-domesticated","Wild"))+scale_x_discrete(limits = c("Phylum", "Class","Order","Family","Genus","species.epithet"),labels= c("Phylum", "Class","Order","Family","Genus","Species"))

```

```{r}
MixedModel <- lmer(Zr ~ Vert*Thermy*D.W*L.F + (1|Study.ID) + (1|Family/Genus/species.epithet), data = data)

summary(MixedModel)

MixedModel1 <- lmer(Zr ~ Vert*Thermy*D.W + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data) 

MixedModel1a <- lmer(Zr ~ Vert*Thermy*L.F + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data)

MixedModel1b <- lmer(Zr ~ Vert*D.W*L.F + (1|Study.ID) +(1|Family/Genus/species.epithet),data = data)

MixedModel1c <- lmer(Zr ~ Vert*Thermy*D.W + (1|Study.ID)+ (1|Family/Genus/species.epithet),data = data) #Best Model according to lrtest

MixedModel1d <- lmer(Zr ~ Thermy*D.W*L.F + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data)

MixedModel2 <- lmer(Zr ~ Vert*Thermy + (1|Study.ID)+ (1|Family/Genus/species.epithet),data = data)

MixedModel2a <- lmer(Zr ~ Vert*D.W + (1|Study.ID)+ (1|Family/Genus/species.epithet),data = data)

MixedModel2b <- lmer(Zr ~ Vert*L.F + (1|Study.ID)+ (1|Family/Genus/species.epithet),data = data)

MixedModel2c <- lmer(Zr ~ D.W*Thermy + (1|Study.ID)+ (1|Family/Genus/species.epithet),data = data)

MixedModel2d <- lmer(Zr ~ L.F*Thermy + (1|Study.ID)+(1|Family/Genus/species.epithet),data = data)

MixedModel2e <- lmer(Zr ~ L.F*D.W + (1|Study.ID)+ (1|Family/Genus/species.epithet),data = data) #Best Model according to lrtest

MixedModel3 <- lmer(Zr ~ Vert + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data)

MixedModel3a <- lmer(Zr ~ Thermy + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data) #Best Model according to lrtest

MixedModel3b <- lmer(Zr ~ D.W + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data)


MixedModel3c <- lmer(Zr ~ L.F + (1|Study.ID)+(1|Family/Genus/species.epithet), data = data)

lrtest(MixedModel, MixedModel1, MixedModel1a, MixedModel1b,MixedModel1c,MixedModel1d,MixedModel2,MixedModel2a,MixedModel2b,MixedModel2c,MixedModel2d,MixedModel2e, MixedModel3,MixedModel3a,MixedModel3b,MixedModel3c) 
```

```{r}
AIC(MixedModel, MixedModel1, MixedModel1a, MixedModel1b,MixedModel1c,MixedModel1d,MixedModel2,MixedModel2a,MixedModel2b,MixedModel2c,MixedModel2d,MixedModel2e, MixedModel3,MixedModel3a,MixedModel3b,MixedModel3c)

BIC(MixedModel, MixedModel1, MixedModel1a, MixedModel1b,MixedModel1c,MixedModel1d,MixedModel2,MixedModel2a,MixedModel2b,MixedModel2c,MixedModel2d,MixedModel2e, MixedModel3,MixedModel3a,MixedModel3b,MixedModel3c)
```


```{r}
library(sjPlot) #for plotting lmer models
tab_model(MixedModel1c,
                  show.re.var= TRUE,
                  pred.labels =c("(Intercept)", "Vertibrate", "Endotherm", "Semi-domesticated", "Wild", "Vertibrate × Wild", "Endotherm × Semi-domesticated"),
                  dv.labels= "Effects of Fixed Effects on Heritability")

p <-sjPlot::plot_model(MixedModel1c,axis.labels=c("Endotherm × Semi-domesticated", "Vertibrate × Wild", "Wild", "Semi-domesticated", "Endotherm", "Vertibrate", "Endotherm × Semi-domesticated"),
                   show.values=TRUE, show.p=TRUE,
                   title="Effects of Fixed Effects on Heritability")
p+theme_sjplot()
```

